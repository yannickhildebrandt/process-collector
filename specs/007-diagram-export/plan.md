# Implementation Plan: Diagram Export

**Branch**: `007-diagram-export` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/007-diagram-export/spec.md`

## Summary

Add client-side export of the BPMN diagram from the process detail page as PNG (via native Canvas API) or PDF with paper size selection A0–A4 (via jsPDF + svg2pdf.js). The bpmn-js `saveSVG()` API extracts the full diagram as SVG, which is then converted to the target format. No server-side changes needed.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 22+
**Primary Dependencies**: Next.js 16.1.6, React 19, bpmn-js 18 (NavigatedViewer), jsPDF, svg2pdf.js
**Storage**: N/A (no schema changes, client-side only)
**Testing**: Manual testing per quickstart.md checklist
**Target Platform**: Browser (desktop + mobile)
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: PNG export < 3s, PDF export < 5s
**Constraints**: Client-side only, no server rendering dependency
**Scale/Scope**: Modifications to BpmnViewer component + process detail page + new export utility + i18n keys

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. AI-Guided, Not AI-Replaced | PASS | No AI involvement — export is a utility function |
| II. Self-Service by Design | PASS | One-click export, no external help needed |
| III. Structured Output over Free Text | PASS | Exports the structured BPMN artifact |
| IV. Configuration as Data, Not Code | PASS | No configuration changes |
| V. LLM-Agnostic by Architecture | PASS | No LLM interaction in this feature |

All gates pass. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/007-diagram-export/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 output (5 decisions)
├── data-model.md        # Phase 1 output (no schema changes)
├── quickstart.md        # Phase 1 output (test checklist)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── app/[locale]/projects/[projectId]/processes/[processId]/
│   └── page.tsx                        # UPDATE: Add export button, wire viewer ref
├── components/processes/
│   └── bpmn-viewer.tsx                 # UPDATE: Add onViewerReady callback prop
├── lib/
│   └── export/
│       └── diagram-export.ts           # NEW: svgToPng() and svgToPdf() utility functions
└── i18n/messages/
    ├── en.json                         # UPDATE: Add export-related i18n keys
    └── de.json                         # UPDATE: Add export-related i18n keys
```

**Structure Decision**: New export utility in `src/lib/export/`. Minimal changes to existing components — only add a callback prop to BpmnViewer and export UI to the process detail page.

### Key Implementation Details

**BpmnViewer changes**:
- Add optional `onViewerReady?: (viewer: unknown) => void` callback prop
- Call it after successful `importXML` + `zoom("fit-viewport")` in `initViewer()`
- Pass `null` on destroy (cleanup)

**Export utility** (`src/lib/export/diagram-export.ts`):
- `exportDiagramAsPng(viewer, title)`: calls `saveSVG()`, converts to Canvas at 2x, downloads as PNG
- `exportDiagramAsPdf(viewer, title, paperSize)`: calls `saveSVG()`, creates jsPDF with landscape orientation, uses svg2pdf.js to render SVG as vector PDF, downloads

**Paper sizes** (landscape, mm):
- A0: 1189 × 841
- A1: 841 × 594
- A2: 594 × 420
- A3: 420 × 297
- A4: 297 × 210

**Export UI on process detail page**:
- Export button in the header area (next to back button / title)
- Dropdown or popover with: "Export as PNG" and "Export as PDF" with sub-options for paper size
- Button hidden when no BPMN, disabled while diagram is loading
- File name: process title sanitized (spaces → hyphens, special chars removed)

**New dependencies**:
- `jspdf` (~150KB)
- `svg2pdf.js` (~150KB)

**i18n keys** (under `processes` namespace):
- `export`, `exportPng`, `exportPdf`, `exportPaperSize`, `exporting`, `exportError`
